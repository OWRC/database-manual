---
title:  "Appendix G.22"
author: "ormgpmd"
date:   "20220210"
output: html_document
knit:   (
            function(input_file, encoding) {
                out_dir <- '';
                rmarkdown::render(
                    input_file,
                    encoding=encoding,
                    output_file=file.path(dirname(input_file), out_dir,
                    'G_22.html')
                )
            }
        )
---

## G.22 Incorporation of the MOE Permit-To-Take-Water database

* Tables
    + D_LOCATION
    + D_LOCATION_PURPOSE
    + D_LOCATION_QA
    + D_PTTW
    + D_PTTW_RELATED
    + D_PTTW_RELATED_SRC
    + R_PTTW_SOURCEID_CODE
    + R_PTTW_WATER_SOURCE_CODE

* Estimated Recurrence Time: yearly (or better)

Refer to Section 2.3.8 for details concerning the format and mapping of the
PTTW data source format to that of the ORMGP database.

Here, we describe the process by which this information is incorporated.  Note
that almost all processing is accomplished through a separate relational
database system outside of the MSSQL environment (except in certain cases,
which will be noted).

#### G.22.0 Determine Those Records to be Examined (for the ORMGP Study Area)

***Existing records (00a)***

Extract all existing PTTW records that have previously been imported.  These
are written to a temporary database then incorporated in the PTTW project.

    select
    dloc.loc_id
    ,dp.pttw_permit_number
    ,dp.pttw_issueddate
    into temphold.dbo.pttw_all_20210604
    from 
    oak_20160831_master.dbo.d_location as dloc
    inner join oak_20160831_master.dbo.d_pttw as dp
    on dloc.loc_id=dp.loc_id
    where 
    loc_type_code=22

*Query: 00a_PTTW_All_src_code*

***Nullify fields in source database (00b)***

Empty fields should be converted to a NULL (or nodata) value.  There will be
many fields affected, only a single example is provided.

    update [Database_20210607]
    set
    [Expired_by]=null
    where 
    [Expired_by]=' '

*Query: 00b_Nullify_Source*

***PTTW records within the ORMGP study area (00c)***

Create geometries for reach record in the source data using the latitude and
longitude fields (so as to avoid any UTM zone issues).  Use these to delimit
these records to the ORMGP study area (with a buffer).  A spatial exercise,
the code for doing so is not shown here.

*Query: 00c_Coordinates_Study_Area*

***PTTW client names - Optional (00d)***

In the case of the 20210607 PTTW database, some processing had been done with
the 20210401 PTTW database.  The client names and permit numbers in the latter
were used to updated the former.  This will generally not be a usual step in
regular processing.

*Query: 00d_PTTW_Clientname*

#### G.22.1 Determine Those Records to be Incorporated

***Current data (01a)***

Create a query to pull the PTTW_PERMIT_NUMBER and PTTW_ISSUEDDATE fields
from the existing data.

    select 
    [PTTW_PERMIT_NUMBER] as [NAME]
    ,[PTTW_ISSUEDDATE] as [PERMIT_ISSUED_DATE]
    from 
    [pttw_all_20210604]
    group by 
    [PTTW_PERMIT_NUMBER],[PTTW_ISSUEDDATE]

*Query: 01a_QCMP_DB*

***New data (01b)***

Create a query to pull the PTTW_PERMIT_NUMBER and PTTW_ISSUEDDATE fields for
the new data.

    select 
    [PERMITNO]
    ,[ISSUEDDATE]
    ,1 as [present]
    from 
    [Database_20210607_ORMGP]
    group by 
    [PERMITNO],[ISSUEDDATE]

*Query: 01b_QCMB_New*

***Comparison table (01c)***

Create a new table that relates the new versus the current permit records
using the queries as a source.  Add a key field to this table.

    select 
    [01b_QCMB_New].*
    into TCMP_DB_and_New_20210607
    from 
    [01b_QCMB_New]
    inner join [01a_QCMP_DB]
    on [01b_QCMB_New].[PERMITNO]=[01a_QCMP_DB].[NAME] and [01b_QCMB_New].[ISSUEDDATE]=[01a_QCMP_DB].[PERMIT_ISSUED_DATE]

*Query:: 01c_QCMB_DB_and_New*

***Presently loaded (01d)***

Add a *present* field to the new dataset and mark those (with a value of *1*)
that are already present in the current database.

    update 
    (
    select
    d.rkey
    ,d.present
    ,t.present as present_upd
    from 
    [Database_20210607_ORMGP] as d
    inner join 
    (
    select 
    [Database_20210607_ORMGP].[rkey]
    ,[TCMP_DB_and_New_20210607].[present]
    from 
    [Database_20210607_ORMGP]
    inner join [TCMP_DB_and_New_20210607]
    on [Database_20210607_ORMGP].[PERMITNO]=[TCMP_DB_and_New_20210607].[PERMITNO] 
    and [Database_20210607_ORMGP].[ISSUEDDATE]=[TCMP_DB_and_New_20210607].[ISSUEDDATE]
    ) as t
    on d.rkey=t.rkey
    ) as t2
    set
    present=present_upd

*Query: 01d_QCMP_Present*

Check if the ISSUEDDATE is null and compare those permit numbers to those
currently in the database.  Include them as appropriate.  (This code is not
shown.)

*Query: 01e_QCMP_Null*

#### G.22.2 Check for Duplicates

***Find duplicates (02a)***

Add a *duplicate* field to the new data table.  Create a query to pull those
records that can be considered duplicates based upon the examined fields.

    select 
    t.[PERMITNO]
    ,t.[rcount]
    ,t.rkey_min
    ,t.rkey_max
    from 
    (
    select 
    [PERMITNO]
    ,min([rkey]) as rkey_min
    ,max([rkey]) as rkey_max
    ,count(*) as rcount
    from 
    [Database_20210607_ORMGP]
    where 
    [present] is null
    and [duplicate] is null
    group by 
    [PERMITNO]
    ,[CLIENTNAME]
    ,[PURPOSECAT]
    ,[SPURPOSE]
    ,[EXPIRYDATE]
    ,[ISSUEDDATE]
    ,[RENEWDATE]
    ,[OLDCTYTWN]
    ,[P_LOT]
    ,[P_CON]
    ,[P_MUNICIP]
    ,[P_UPPERT]
    ,[P_LOWERT]
    ,[SURFGRND]
    ,[SOURCEID]
    ,[EASTING]
    ,[NORTHING]
    ,[UTMZONE]
    ,[MAXL_DAY]
    ,[DAYS_YEAR]
    ,[HRS_DAYMAX]
    ,[L_MINUTE]
    ,[AMENDED_BY]
    ,[EXPIRED_BY]
    ,[ACTIVE]
    ,[PERMIT_END]
    ) as t
    where 
    t.rcount>1

*Query: 02a_QDuplicates_Check*

***Mark duplicates (02b)***

Mark those records (with the largest *key* value) as the duplicate.  This may
need to be run-though more than once.  These records will not be included in
the import process.

This will create a temporary table:

    select
    d.rkey
    ,q.rkey_max
    into dup_to_mark
    from 
    [Database_20200519] as d
    inner join [02a_QDuplicates_Check] as q
    on d.rkey=q.rkey_max

Followed by the actual updtate:

    update (
    select
    d.rkey
    ,d.permitno
    ,d.duplicate
    from 
    [Database_20200519] as d
    inner join [dup_to_mark] as m
    on d.rkey=m.rkey
    ) as t
    set
    duplicate=1

*Query: 02b_QDuplicates_Mark*

***Subset new data (02c)***

Create a subset of the new dataset that will be processed and imported into
the current database.  This includes those that:

* Occur with the ORMGP study area
* Are not already present in the current database
* Are not duplicate records

select
d.*
into Database_20210607_ORMGP_subset
from 
[Database_20210607_ORMGP] as d
where 
[present] is null
and [study_area]=1 
and [duplicate] is null

*Query: 02c_QSubset*




