---
title:  "Appendix G.22"
author: "ormgpmd"
date:   "20220204"
output: html_document
knit:   (
            function(input_file, encoding) {
                out_dir <- '';
                rmarkdown::render(
                    input_file,
                    encoding=encoding,
                    output_file=file.path(dirname(input_file), out_dir,
                    'G_22.html')
                )
            }
        )
---

## G.22 Incorporation of the MOE Permit-To-Take-Water database

* Tables
    + D_LOCATION
    + D_LOCATION_PURPOSE
    + D_LOCATION_QA
    + D_PTTW_PERMIT
    + D_PTTW_SOURCE
    + R_PTTW_CLIENT_CODE
    + R_PTTW_WATER_SOURCE

* Estimated Recurrence Time: yearly (or better)

Refer to Section 2.3.8 for details concerning the format and mapping of the
PTTW data source format to that of the ORMGP database.

Here, we describe the process by which this information is incorporated.

REPLACE (ALMOST) ALL OF THE FOLLOWING TEXT

The following fields are found within the MOE Permit-To-Take-Water (PTTW) database:

    - PERMITNO 
    - CLIENTNAME
    - PURPOSECAT
    - SPURPOSE
    - EXPIRYDATE
    - ISSUEDDATE
    - RENEWDATE
    - OLDCTYTWN
    - P_LOT
    - P_CON
    - P_MUNICIP
    - P_UPPERT
    - P_LOWERT 
    - SURFGRND
    - SOURCEID 
    - EASTING
    - NORTHING
    - UTMZONE
    - MAXL_DAY
    - DAYS_YEAR
    - HRS_DAYMAX
    - L_MINUTE
    - AMENDED_BY 
    - EXPIRED_BY
    - PERMIT_END
    - ACTIVE
    - LATITUDE 
    - LONGITUDE

Explanations for conversion or mapping of these fields are described below (descriptions are from the 'Field_Description' sheet of the imported database/excel file).

PERMITNO 
Permit number for water  taking.

Mapped to D_PTTW_PERMIT.PTTW_PERMIT_NUMBER

CLIENTNAME
Name of client requesting a permit.

Convert to numeric D_PTTW_PERMIT.PTTW_CLIENT_CODE; based upon contents of R_PTTW_CLIENT_CODE (linked by PTTW_CLIENTNAME; note that this table is created by finding the distinct CLIENTNAMEs from the input dataset).

PURPOSECAT
Major taking category.

Convert to D_LOCATION_PURPOSE.PURPOSE_PRIMARY_CODE; based upon contents of R_PURPOSE_PRIMARY_CODE (the description of the PURPOSECAT is checked against those found in R_PURPOSE_PRIMARY_CODE).  Check that the purpose is already defined within R_PURPOSE_PRIMARY_CODE (and add as necessary).

SPURPOSE
Specific purpose.

Convert to D_LOCATION_PURPOSE.PURPOSE_SECONDARY_CODE; based upon contents of R_PURPOSE_SECONDARY_CODE (the description of SPURPOSE is checked against those found in R_PURPOSE_SECONDARY_CODE).  Check that the purpose is already defined (and add as necessary)..

In the case of 'Municipal', check PURPOSECAT to differentiate between 'Exploration', 'Monitoring' and 'Supply' (they will most likely be 'Municipal Supply').

EXPIRYDATE
Expiry date of permit.

Mapped to D_LOCATION.LOC_END_DATE as well as D_PTTW_PERMIT.PTTW_EXPIRYDATE.  Any invalid dates (usually empty in the original) are assigned the tag '1867-07-01'.  Any invalid years (usually greater than '2050') are assigned the year '1867'.

ISSUEDDATE
Date the permit was issued

Mapped to D_LOCATION.LOC_START_DATE.  Refer to EXPIRYDATE (above) regarding invalid dates.

RENEWDATE
Date that a legacy permit was renewed (legacy permits are those that were issued before 2005).

Mapped to D_PTTW_PERMIT.PTTW_RENEWDATE.  Note that this is not a date (rather, a numeric).

OLDCTYTWN
Former township name related to lot/concession.

Mapped to D_PTTW_SOURCE.PTTW_OLDCTYTWN.  Note that in most cases, the value here seems to match P_MUNICIP ( if declared) from the import database.

P_LOT
Lot where permit is located.

This column contains information in a 'free-form' format; it can include LOT numbers, CONCESSION numbers and general addresses.  As such, a straight numeric (or readily identified lot number) maps to D_LOCATION.LOC_LOT; the contents of P_LOT (regardless of numeric or address info) is copied to D_LOCATION.LOC_ADDRESS_INFO1.  All 'NA' values (only - no other text is present) should be removed.

An attempt to handle concessions and lots specified internally (e.g. as part of the address) will be made using search routines.  For lot's, the following code can be used:

select 
 [LOT and CON].[rnum]
,regexp([LOT and CON].[P_LOT],"(.*)(Lot ?[0-9][0-9]?)(.*)","$2") as [test]
from 
[LOT and CON]
where 
[P_LOT] likex ".*Lot ?[0-9][0-9]?.*"

For concessions, the following codes can be used:

select 
 [LOT and CON].[rnum]
,regexp([LOT and CON].[P_LOT],"(.*)(Concession ?[0-9][0-9]?)(.*)","$2") as [regexp_CONCESSION]
from 
[LOT and CON]
where 
[P_LOT] likex ".*Concession ?[0-9][0-9]?.*"

Note that multiple iterations are necessary as, for example, 'Lot' could also be specified as 'Lt' (and other combinations) and 'Concession' could also be specified as 'Conc' (and other combinations).  Both the P_LOT and P_CONC columns need to be examined.

P_CON
Concession where permit is located.

The information contained here is similar to that found in P_LOT and will be handled in much the same way.  Note that a straight numeric (or readily identified concession number) will map to D_LOCATION.LOC_CON while address information will map to LOC_ADDRESS_INFO2.  Refer to 'P_LOT' above for details.

P_MUNICIP
Current municipality where permit is located.

Map to D_LOCATION.LOC_TOWNSHIP_CODE.  Also can be used to populate D_LOCATION.LOC_COUNTY_CODE.  Note that modifications to R_LOC_TOWNSHIP_COE.LOC_TOWNSHIP_ABBR have been made to perform 'easier' matches to text strings from this field (and used to populate LOC_COUNTY_CODE, only).

P_UPPERT
Upper tier (county/district/regional municipality) where permit is located.

Mapped to D_PTTW_SOURCE.PTTW_P_UPPERT.

P_LOWERT 
Lower tier (county/district/regional municipality) where permit is located.

Mapped to D_PTTW_SOURCE.PTTW_LOWERT.

SURFGRND
Origin of water taking: Surface, Ground or Both

Indicates the source of water, one of: surface, groundwater or both.  Change to lookup code PTTW_WATER_SOURCE_CODE (table R_PTTW_WATER_SOURCE_CODE).  Mapped to D_PTTW_PERMIT.PTTW_WATER_SOURCE_CODE.

SOURCEID 
Description of exact location of water taking.

Mapped to D_PTTW_SOURCE.PTTW_SOURCEID.

EASTING
Easting coordinates in UTM.

Only used if LATITUDE/LONGITUDE is not defined.  The assumed datum is NAD83.  Coordinates are translated to longitude.  If blank, a QA_COORD_CONFIDENCE_CODE of '117' will be applied.  Refer to 

Mapped (when used) to D_LOCATION.LOC_COORD_EASTING_OUOM.

NORTHING
Northing coordinates in UTM.

Refer to EASTING (above) for use.  Coordinates are translated to latitude.

Mapped (when used) to D_LOCATION.LOC_COORD_NORTHING_OUOM.

UTMZONE
UTM Zone (one of 15, 16, 17 or 18).

Only used if LATITUDE/LONGITUDE is not defined.  If blank, a value of NAD83Z17 is assumed.  Used in conjunction with EASTING and NORTHING to assign latitude and longitude.

MAXL_DAY
Maximum litres allowed per day.

Mapped to D_PTTW_PERMIT.PTTW_MAX_L_DAY.

DAYS_YEAR
Number of days that water taking is allowed.

Mapped to D_PTTW_PERMIT.PTTW_MAX_DAYS_YEAR.

HRS_DAYMAX
Maximum water taking in hours per day.

Mapped to D_PTTW_PERMIT.PTTW_MAX_HRS_DAY.

L_MINUTE
Allowable taking per minute (in litres).

Map to D_PTTW_PERMIT.PTTW_MAX_L_MINUTE.

AMENDED_BY 
Pervious permit number.

Mapped to D_PTTW_PERMIT.PTTW_AMENDED_BY.

EXPIRED_BY
Previous permit number.

Mapped to D_PTTW_PERMIT.PTTW_EXPIRED_BY.

PERMIT_END
Date at which the water permit ends.

Refer to EXPIRYDATE (above) regarding invalid dates.

Mapped to D_PTTW_PERMIT.PTTW_EXPIRYDATE.

ACTIVE
Indicates whether the permit is active or expired (yes/no) based on PERMIT_END and the date that data was extracted from the source database.

Mapped to D_LOCATION.LOC_ACTIVE (a 0/1 field).

LATITUDE 
The latitude coordinates.

Mapped to LOC_COORD_NORTHING_OUOM.  Where this value is not defined, NORTHING is used instead.  A NAD83 datum is assumed.

LONGITUDE
The longitude coordinates.

Mapped to LOC_COORD_EASTING_OUOM.  Where this value is not defined, EASTING is used instead.  A NAD83 datum is assumed.

Primary Key - Input Database

Each row from the input database is tagged with a separate numeric value (using an 'Arithmetic Series' with a step of '1').  This allows each row to be identified with a 'primary key' (similar to a database-table).

Additional Information

In addition, the following information is incorporated:

D_LOCATION

Coordinates

The coordinates (both UTM and Latitude/Longitude) are assumed to have a NAD83 datum.  Any UTMZONE with a value of '0' is assumed to have a value of '17' (i.e. Zone 17).  Latitude and Longitude are used to convert to UTMZ17 coordinates (the former are used as OUOM values).  If only UTM coordinates are available, those are used as a substitute.  If neither Latitude/Longitude or UTM coordinates are available, the QA_COORD_CONFIDENCE_CODE is assigned a value of '117' and the coordinates and zone are given a NULL value.

Lots and Concessions

Any empty P_LOT or P_CON is considered undefined.  Any P_LOT or P_CON with a value of 'NA' (or similar) or '0' is also considered undefined.  These are removed from consideration (made NULL).

D_LOCATION_QA

Each PTTW location is assigned a QA_COORD_CONFIDENCE_CODE of '5' (with the ?)

R_LOC_TOWNSHIP_CODE

The LOC_TOWNSHIP_ABBR field has been updated (currently empty in R_LOC_TOWNSHIP_CODE) to reflect easier-to-match strings for the PTTW free-form database (and can be used for other import data).  This comparison has been done through a combination of R_LOC_COUNTY_CODE and R_LOC_TOWNSHIP_CODE where both have a LOC_COUNTY_CODE field (the information we are trying to determine for the pecific PTTW).  Note that the PTTW location LOC_COUNTY_CODE can only be populated in this manner (not the LOC_TOWNSHIP_CODE).

Duplicates

A check against duplicate records should be made.  This can be performed against the source database and/or the populated (i.e. for import) tables.  An SQL 'GROUP BY' check - where all columns in the source database are specified - is used to see what columns are 'exactly' the same.   The results can be examined and any offending rows removed; those that are 'approximately' the same are grouped together into one record with appropriate notes made in PTTW_SOURCE_COMMENT (as found in D_PTTW_SOURCE) and/or PTTW_PERMIT_COMMENT (as found in D_PTTW_PERMIT) of this change.  The number of rows 'grouped' together due to duplication is indicated by the PTTW_GROUPED field in D_PTTW_SOURCE (where the number indicated here represents the 'total' number of inputs rows, including this one); this field should be NULL otherwise.

D_LOCATION is then examined (using all fields) to determine duplicate 'locations' (i.e. the same coordinates and information with the same LOC_NAME and etc?).  The minimum value for the 'rkey' (i.e. the key that we're using to originally number the rows from the input file; remember that this was a straight 'Arithmetic Series' with a step of '1') is determined as well - this is the 'row' that we'll keep as the 'main' location.  All other of these rows will be removed from the D_LOCATION table (but will remain in the D_PTTW_PERMIT and D_PTTW_SOURCE tables) as well as the D_LOCATION_QA table.  For D_LOCATION_PURPOSE, the purpose codes will be examined and any duplication (i.e. the same primary key and the same PURPOSE_PRIMARY_CODE and PURPOSE_SECONDARY_CODE) will be removed.  Note that there should be the same or more rows in D_LOCATION_PURPOSE than in D_LOCATION (unless non-assigned purposes are removed).

Master Database Incorporation

At this point, all tables will be linked together with a non-unique (to the master database) identifier.  A new unique identifier (depending upon the table) should be assigned based upon existing values within the master database (e.g. assignment of new LOC_IDs or SYS_RECORD_IDs).  Each table should be updated with these numeric values.  All non-values (usually signified with a '-9999' place holder) should be assigned a NULL.  The input information can now be added to the master database.

