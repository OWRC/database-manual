---
title:  "Appendix G.22"
author: "ormgpmd"
date:   "20220209"
output: html_document
knit:   (
            function(input_file, encoding) {
                out_dir <- '';
                rmarkdown::render(
                    input_file,
                    encoding=encoding,
                    output_file=file.path(dirname(input_file), out_dir,
                    'G_22.html')
                )
            }
        )
---

## G.22 Incorporation of the MOE Permit-To-Take-Water database

* Tables
    + D_LOCATION
    + D_LOCATION_PURPOSE
    + D_LOCATION_QA
    + D_PTTW
    + D_PTTW_RELATED
    + D_PTTW_RELATED_SRC
    + R_PTTW_SOURCEID_CODE
    + R_PTTW_WATER_SOURCE_CODE

* Estimated Recurrence Time: yearly (or better)

Refer to Section 2.3.8 for details concerning the format and mapping of the
PTTW data source format to that of the ORMGP database.

Here, we describe the process by which this information is incorporated.  Note
that almost all processing is accomplished through a separate relational
database system outside of the MSSQL environment (except in certain cases,
which will be noted).

#### G.22.0 Determine Those Records to be Examined (for the ORMGP Study Area)

***Existing records (00a)***

Extract all existing PTTW records that have previously been imported.  These
are written to a temporary database then incorporated in the PTTW project.

    select
    dloc.loc_id
    ,dp.pttw_permit_number
    ,dp.pttw_issueddate
    into temphold.dbo.pttw_all_20210604
    from 
    oak_20160831_master.dbo.d_location as dloc
    inner join oak_20160831_master.dbo.d_pttw as dp
    on dloc.loc_id=dp.loc_id
    where 
    loc_type_code=22

**Query: 00a_PTTW_All_src_code**

***Nullify fields in source database (00b)***

Empty fields should be converted to a NULL (or nodata) value.  There will be
many fields affected, only a single example is provided.

    update [Database_20210607]
    set
    [Expired_by]=null
    where 
    [Expired_by]=' '

**Query: 00b_Nullify_Source**

***PTTW records within the ORMGP study area (00c)***

Create geometries for reach record in the source data using the latitude and
longitude fields (so as to avoid any UTM zone issues).  Use these to delimit
these records to the ORMGP study area (with a buffer).  A spatial exercise,
the code for doing so is not shown here.

**Query: 00c_Coordinates_Study_Area**

***PTTW client names - Optional (00d)***

In the case of the 20210607 PTTW database, some processing had been done with
the 20210401 PTTW database.  The client names and permit numbers in the latter
were used to updated the former.  This will generally not be a usual step in
regular processing.

**Query: 00d_PTTW_Clientname**

#### G.22.1 Determine Those Records to be Incorporated

***PTTW - New data (01a)***

Assemble a query to pull the PTTW_PERMIT_NUMBER and PTTW_ISSUEDDATE fields
from the new source data.

select 
[PTTW_PERMIT_NUMBER] as [NAME]
,[PTTW_ISSUEDDATE] as [PERMIT_ISSUED_DATE]
from 
[pttw_all_20210604]
group by 
[PTTW_PERMIT_NUMBER],[PTTW_ISSUEDDATE]

**Query: 01a_QCMP_DB**

